## 一、 配置 ssh 远程登录

1、 本地生成秘钥对

```
ssh-keygen -t rsa -C 'comment message'
```

2、 登录远程服务器，编辑sshd 配置文件

```
vim /etc/ssh/sshd_config 
PubkeyAuthentication yes #允许公匙认证
```

其他配置如下：

```
Port #自定义端口号
PermitRootLogin yes #允许root登录
PasswordAuthentication yes #允许密码认证
PermitEnptyPassword no #禁止空密码登录
```

重启ssh服务：

```
/etc/init.d/ssh restart
```

3、将本机ssh公匙上传至服务器

```
ssh-copy-id -i id_rsa.pub -p 22 root@hostip
```

![](file:///C:\Users\Admin\AppData\Local\Temp\ksohtml16472\wps46.jpg)

## **二、浏览器提示“**403”、“404”、“502”、“503”等错误**

浏览器提示数字类错误时，通常表明客户端与服务端的网络是正常的，但网站资源或后端服务存在异常，报错情况比较复杂，以下列出比较常见的几种报错内容。

**1**、**403 报错：**

403 报错是一个大类，403 的报错基本上是权限问题，出现 403 报错时您需要检测权限配置问题。以下是关于 403 报错中具体报错的介绍。

| 403.1  | 错误是由于执行访问被禁止而造成的。若试图从目录中执行CGI、ISAPI 或其他可执行程序，但该目录不允许执行程序时便会出现此种错误。                                         |
| ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 403.2  | 错误是由于读取访问被禁止而造成的。导致此错误是由于没有可用的默认网页并且没有对目录启用目录浏览，或者要显示的HTML 网页所驻留的目录仅标记为“可执行”或“脚本”权限。 |
| 403.3  | 错误是由于写入访问被禁止而造成的。当试图将文件上载到目录或在目录中修改文件，但该目录不允许“写”访问时就会出现此种错误。                                            |
| 403.4  | 错误是由于要求SSL 而造成的。您必须在要查看的网页的地址中使用 HTTPS。                                                                                                |
| 403.5  | 错误是由于要求使用128 位加密算法的 Web 浏览器而造成的。如果您的浏览器不支持 128 位加密算法就会出现这个错误，您可以连接微软网站进行浏览器升级。                      |
| 403.6  | 错误是由于IP 地址被拒绝而造成的。如果服务器中有不能访问该站点的 IP 地址列表，并且您使用的 IP 地址在该列表中时您就会返回这条错误信息。                               |
| 403.7  | 错误是因为要求客户证书。当需要访问的资源要求浏览器拥有服务器能够识别的安全套接字层（SSL）客户证书时会返回此种错误。                                                 |
| 403.8  | 错误是由于禁止站点访问而造成的。若服务器中有不能访问该站点的DNS 名称列表，而您使用的 DNS 名称在列表中时就会返回此种信息。请注意区别 403.6 与 403.8 错误。           |
| 403.9  | 错误是由于连接的用户过多而造成的，由于Web 服务器很忙，因通讯量过多而无法处理请求时便会返回这条错误。                                                                |
| 403.10 | 错误是由于无效配置而导致的错误。当试图从目录中执行CGI、ISAPI 或其他可执行程序，但该目录不允许执行程序时便会返回这条错误。                                           |
| 403.11 | 错误是由于密码更改而导致无权查看页面。                                                                                                                              |
| 403.12 | 错误是由于映射器拒绝访问而造成的。若要查看的网页要求使用有效的客户证书，而客户证书映射没有权限访问该Web 站点时就会返回映射器拒绝访问的错误。                        |
| 403.13 | 错误是由于需要查看的网页要求使用有效的客户证书而使用的客户证书已经被吊销，或者无法确定证书是否已吊销造成的。                                                        |
| 403.14 | 错误Web 服务器被配置为不列出此目录的内容，拒绝目录列表。                                                                                                            |
| 403.15 | 错误是由于客户访问许可过多而造成的。当服务器超出其客户访问许可限制时会返回此条错误。                                                                                |
| 403.16 | 错误是由于客户证书不可信或者无效而造成的。                                                                                                                          |
| 403.17 | 错误是由于客户证书已经到期或者尚未生效而造成的。                                                                                                                    |

**2**、**404 报错：**

404 报错主要是页面显示问题或者页面的链接有问题，意味着链接指向的网页不存在，即原始网页的 URL 失效。当 Web 服务器接到类似请求时，会返回一个 404 状态码，告诉浏览器已请求的资源并不存在。导致这个错误的原因一般有以下几种情况。

| 1 | 无法在所请求的端口上访问Web 站点。                                                              |
| - | ----------------------------------------------------------------------------------------------- |
| 2 | Web 服务扩展锁定策略阻止本请求。                                                                |
| 3 | MIME 映射策略阻止本请求。                                                                       |
| 4 | 网站更新改版，但某些局部板块沿用原来的模块，而原有的模块调用的文件已经被删除或转移了路径。      |
| 5 | 跟踪访问的各类脚码或CSS 文件无效但调用代码依然存在。                                            |
| 6 | 某个目录被直接删除（导致一段时间该目录的文件在被爬行时全部报“404 Not Found”错误）。           |
| 7 | 网页URL 生成规则改变、网页文件更名或移动位置、导入链接拼写错误等，导致原来的 URL 地址无法访问。 |

**3**、**502 报错：**

当测试访问报错为502 Bad Gateway，这是 Web 程序配置异常导致的。建议结合 Web 访问日志，检测一下 Web 程序配置的参数设置是否有异常。

**4**、**503 报错：**

503 报错是一种 HTTP 状态码，与 404 同属一种网页状态出错码。两者的区别是：前者是服务器出错的一种返回状态，后者是网页程序没有相关结果后返回的一种状态。503 报错产生的原因有可能是以下几种情况。

| 1 | 网络管理员可能关闭应用程序池以执行维护。                                                                                                                                                                                                                                                                            |
| - | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2 | 当请求到达时应用程序池队列已满。                                                                                                                                                                                                                                                                                    |
| 3 | 应用程序池标识没有使用预定义账户：网络服务。而自己配置了标识，但是配置的这个用户不属于IIS_WPG 组。                                                                                                                                                                                                                  |
| 4 | 应用程序池启用了CPU 监视，并且设置了 CPU 使用率超过一定百分比关闭应用程序池，而开发人员写的服务端页面执行效率不高，会引起 CPU 的长时间占用，最终达到设置的百分比，从而引起应用程序池关闭。                                                                                                                          |
| 5 | 应用程序池的性能选项卡的请求队列限制所填的数值太小，默认为1000。                                                                                                                                                                                                                                                    |
| 6 | 某个目录直接删除（导致一段时间该目录的文件在被爬行时全部报404 Not Found 错误）。                                                                                                                                                                                                                                    |
| 7 | 网页URL 生成规则改变、网页文件更名或移动位置、导入链接拼写错误等，导致原来的 URL 地址无法访问。                                                                                                                                                                                                                     |
| 8 | 该站点正在被攻击。对于最新型的攻击，其实是DDoS 的一种派生，原理在于找数千个 IP，同时向服务器发出请求，然后立即断开，让 Apache 处于等待状态，致使 Apache 线程全部被填满，致使服务器死机。因此，为了保证大多数客户的利益，我们给每个空间，作出了每 19 秒 64 个 PHP 请求的限制。一般的图片请求和 HTML 请求不包括在内。 |
| 9 | 该程序占用的PHP 线程过多，有的程序没有进行好优化处理，一个点击即可产生数个，甚至数十个 PHP 线程。这样的话，几个点击就可以把该时段的 64 个 PHP 线程全部填满了。因此出现 503 错误。建议优化一下程序，尽量少用 require（请求）等语句。                                                                                 |

## **三、网站持续运作时偶然无法访问**

此情况下，您需要对ECS 实例状态、Web 服务、后端数据库分别进行检查。

**1、服务器**状态的检查

可以通过阿里云自助诊断工具进行检查，然后根据诊断结果中的提示进行操作。详情请参见[诊断服务器实例的健康状态](https://help.aliyun.com/document_detail/179324.htm)。

**2**、**Web 服务或后端数据库的检查**

请确保Web 服务和后端数据库处于运行状态。如果未运行，请检查日志并根据日志中的错误信息进行修复。

说明：网站服务器的日志文件名一般为access.log 或 error.log，LIMS系统的日志路径请查看produce.php 配置的文件的LOG_DIR 配置项。

## **四、客户端无法访问负载均衡**

服务器有负载均衡SLB 时，可能是 SLB 实例的监听策略设置异常。

1、 服务器内网防火墙设置没有放行80 端口。

a) Linux 服务器上执行以下命令：

b) /etc/init.d/iptables stop

2、 后端端口异常。

a) 参考以下命令，查看返回值是否为HTTP/1.1 200 OK。

b) curl -I 10.XX.XX.1

3、 rp_filter 特性和负载均衡底层 LVS 的策略路由产生冲突，导致访问出现异常。

a) 登录四层负载均衡后端添加的Linux 系统 ECS 实例。

b) 编辑/etc/sysctl.conf 文件，将系统配置文件中的以下三个参数值设置为 0。

i. net.ipv4.conf.default.rp_filter = 0

ii. net.ipv4.conf.all.rp_filter = 0

iii. net.ipv4.conf.eth0.rp_filter = 0

c) 然后执行sysctl -p 命令，使配置生效。

4、 监听功能异常。

a) Linux 服务器上执行以下命令。

b) netstat -anp | grep :80

执行失败，可以提前安装yum install net-tools 或者apt install net-tools。

## **五、无法访问**CDN 加速后的网站

需要先判断是否是源站本身的问题，详情请参见无法访问CDN 加速后的网站。在使用CDN 加速后，如返回 304、403、404、503 和 504 状态码，可参考以下操作进行处理：

**1、如果访问**CDN 加速资源返回 304 状态码

客户端第一次向服务器成功发送请求，服务器会把内容返回给客户端，状态码是200，且会标记内容修改时间，生成一个 ETag 标记，用来核实内容是否修改过。等下次同一客户端再次发送请求，会根据请求标记的修改时间，通过 ETag 标记判断文件内容在这期间是否修改过。如果没有修改过，则返回 304 状态码。

**2、如果访问**CDN 加速资源返回 403 状态码

CDN 访问出现 403 状态码通常情况下可能是由以下几种情况导致的，在排查问题时可以打开浏览器开发者模式，切换到 Netwrok 标签页后，重新请求异常的 URL，复现 403 的问题，然后在 Headers 下查看 CDN 返回的 Response Header，通过这个信息可以判断是什么原因引起的 403 错误。

![image.png](https://foruda.gitee.com/images/1668480795294730679/e1b0a178_68661.png)

3、 **如果访问CDN 加速资源返回 404 状态码。**

如果是通过监控发现404 的错误，则可以通过 CDN 的日志确认出现 404 的 URL。如果已知 404 的 URL，则可以绑定源站测试确认资源是否存在，通常可能有以下几种原因：

A) **源站资源不存在。**

测试访问资源时返回404 的 URL，确认源站是否返回 404，如果源站返回 404，请确认源站的资源是否存在。

B) **回源Host 配置错误。**

回源HOST 是指 CDN 节点在回源过程中，在源站访问的站点域名。如果您需要在自定义 CDN 节点回源时访问具体服务器域名，则需要配置回源 HOST 的域名类型，详情请参见配置回源 HOST。回源 HOST 可选域名类型包括：加速域名、源站域名和自定义域名。如果回源 HOST 配置错误，源站无法识别该回源 HOST，源站也会响应 404。源站和回源 HOST 的区别如下：

a) 源站：指您的业务服务器，决定了回源时请求到的具体IP 地址。

b) 回源HOST：指 CDN 回源请求头中携带的 HOST 字段值，决定了回源请求访问到该 IP 地址上的具体站点。

C) **回源端口配置错误。**

该问题通常发生在源站的端口是非80/443 端口，例如源站 HTTP 服务的端口是 8080，则在 CDN 上配置回源端口时，需要配置自定义回源端口为 8080，且需要关闭协议跟随回源功能，否则自定义端口无法生效

4、 如果访问CDN 加速资源返回 503 状态码。

5、如果访问CDN 加速资源返回 504 状态码。

## **六、无法访问通过防火墙（WAF）防护的网站**

需要先判断是否是源站本身的问题，再判断是否为WAF 误拦截问题。

1、 **检查是否为源站问题**

a) 禁用源站上的安全组、黑白名单、防火墙、安全狗、云锁等应用，防止WAF 回源 IP 被拉入黑名单。

b) 修改本地计算机的hosts 文件，将问题域名的解析指向对应的 ECS 实例、SLB 实例、服务器公网 IP（即在 WAF 上填写的源站 IP 地址）。

c) 通过本地计算机的浏览器访问问题域名，查看访问请求不经过Web 应用防火墙时，是否能复现问题。

i. 如果问题复现，说明可能是源站服务器的响应异常，建议您及时检查源站服务器的工作状态（例如进程、CPU、内存、Web 日志等）是否有异常并修复异常。

ii. 如果问题没有复现，说明不是源站服务器的响应异常

2、 **排查常见访问错误**

a) 出现405 阻断页面或者 HTTP 返回码为 405。

请求被自定义防护策略或者正则防护引擎阻断。

b) 某些IP 在访问网站时显示连接被重置，HTTP 返回码为 302，且在请求头获得 Set-Cookie。

IP 访问触发了 CC 防御规则。

c) 客户端的HTTPS 请求返回证书为[www.notexist.com](http://www.notexist.com)。

Web 应用防火墙需要浏览器支持 SNI，而客户端的浏览器可能不支持 SNI。

d) 网站显示白屏，同时HTTP 返回码为 502。

当源站（指ECS、SLB 或服务器）出现丢包或者不可达的时候，Web 应用防火墙会返回白屏。

e) 域名ping 不通，且收到短信提示，WAF 受 DDoS 攻击，进入了黑洞。DDoS 流量攻击不在 Web 应用防火墙的防护范围内。

f) 微信或支付宝回调失败。

可能是高频访问被CC 防护规则拦截，或者使用了 HTTPS 方式回调，且微信和支付宝不支持 SNI。

## **七、服务器问题汇总**

**1**、**检查哪些尝试入侵服务器的ip 命令**

centos 查看尝试登录服务器的 ip，一般用来查看攻击 ip 来源：

``cat /var/log/secure | awk '/Failed/{print $(NF-3)}'| sort| uniq -c| awk '{print $2"="$1;}'``

然后将以上ip 加入/etc/hosts.deny 文件，格式：all:114.115.116.117

**2**、**远程连接服务器非常慢**

当您远程连接服务器非常慢的时候，请参考以下步骤排查：

1、首先，ping 服务器 IP，看延迟是否正常

2、其次，ping 服务器的网关 IP，对比延迟是否正常

针对以上操作，会有两种情况

情况一：服务器IP 和网关 IP 延迟都较大，则可能是线路问题

情况二：服务器IP 延迟大，网关 IP 延迟正常。多半是服务器本身问题，可能是带宽跑满、服务器负载过大等原因，建议进服务器自行查看资源使用

**3**、**服务器带宽拥堵如何解决**

带宽是服务器托管用户最重视的资源，对于数据延迟以及流量增高往往会十分敏感。那么当带宽跑满的时候我们该如何积极应对才能有效化解这些难题呢？

服务器带宽跑满原因：

1.病毒

　　建议在服务器上安装杀毒软件，进行杀毒。可以通过任务管理器中查看是否异常进程。

2.网络攻击

　　服务器或站点遭受 DDOS 攻击或 CC 攻击等，短期内产生大量的访问需求。

　　可以登陆管理控制台，查看云盾中的防护 DDOS 攻击是否调整好阈值，并核实是否开启 CC 防护。

3.网站规模大

　　网站规模较大(例如门户网站、商城等)，即网站本身访问量需求大，查看网站的 Page View 值、Hits 值、日流量都很高，建议升级带宽 。

　　以上的原因对于用户来说是非常不利的，对于服务器带宽出现带宽跑满的情况，就需要作出处理。

解决办法：逐一排查问题所在，进行处理

1.如果网站规模较大，或者是商城近期搞活动，网站的点击率很高建议升级您的云主机带宽，以免影响您的网站正常运营 。

2.查看网站的 Page View 值、Hits 值、日流量是否正常，对比下和日前是否是突增的，如果是突增那么查看下是否有盗链，请联系程序员解决。

3.分析网站日志，查看网站是否遭受 DDOS 攻击或者是被挂马，短期内产生大量的访问需求。

4.网站页面设计不合理，页面中包含大图片或音频、视频文件等文件，导致网站页面太大 ，因为每个访问者访问您的网站都会将您的网站缓存到本地，这样就产生了大流量，可以进行优化网站处理。

5.网站经营的内容提供数据下载，如果必须网站提供*.mp3,*.rar,*.zip*.exe 等文件的下载，或者是您的网站提供视频、音频文件的播放 ，建议升级您的主机

6.登录系统查看服务器是否被入侵或已经重度，同事进行服务器抓包，分析流量包的内容，查看带宽跑高的原因。

**4**、**服务器如何估算带宽的需求**

服务器用户在带宽的使用上往往无法做到精确确定自己的带宽需要多少，带宽租用少了在实际的使用中会出现不够的情况，而租用多了会出现浪费的情况。然而不同的用户有不同的使用情况，计算贷款的需求更不可一概而论，那么有没有一些例子来说明这个问题呢？

这里以常见的网站平台来说明：

　　对于网站平台来说，网站的性质有所不同，相比计较而言论坛站的访问量是非常大的以及视频下载站也非常的耗用服务器的资源的，每个网站所需要的带宽有所不同。

　　正常的带宽计算方法是这样的：每秒钟下载文件的字节数×8/0.7 = 宽带的速率。这前提是你必须先关闭其他正在运行中的网络应用程序，不能同时下载其他网页和软件。

　　介绍下流量和带宽是怎样换算的，带宽：流量=1:150；例如：1M 带宽=150M 的流量。

1.图片网站或者论坛网站，

　　1M 带宽就相当于 200 人左右在线。假如说是下载的话，那么就要看并发连接数目。最后用并发数目除以每个人所占用的带宽。

　　例如：3200 人同时在线，3200 人并发同时操作，每个人的页面 40KB，那么合算成带宽就是：3200/(40KB*8)=10Mb

2.视频或者音频站

　　例如：网络环境是并发数目是1000，高清视频码率是 2Mbps，标清码率是 1Mbps。假如：1：2，单节点并发按 600 计算，那么它的总输出带宽是多少呢？

　　答：200*2+400*1=800Mbps

　　了解网站带宽的计算方式才能正确估算出服务器所需要的带宽数值，只有这样用户在使用的过程中不会出现资源偏差的 。

**5**、**服务器远程连接不上了处理步骤**

1.如果本地可以远程或者可以 ping 通，说明网络是正常的，这种情况下很可能是您自己本地网络问题，建议您测试一下；如果还是不可以的话您可以做一个 Tracert，从路由看一下详细问题。

2.如果本地不能远程或者 ping 通，说明存在问题；此时试一下本 IP 地址的网关是否正常，如果能够通，说明您服务器问题；如果本 IP 地址的网关不正常，说明大网可能有问题。

## **八、LIMS系统问题汇总**

**1、系统启动提示端口占用**

出现类似 WARNING swSocket_bind(:483): bind(0.0.0.0:9501) failed, Error: Address already in use[98] 如下错误，可判定为端口被占用。

可以通过 lsof 命令来查询端口占用

``lsof -i:9501COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAMEphp 57 root 3u IPv4 1744902 0t0 TCP *:9501 (LISTEN)``

可以根据返回的 pid 使用 kill 命令来关闭占用端口的相关进程

``kill -9 57``

也可以通过修改 LIMS 的监听端口的方式启动 LIMS 的服务，修改文件在 dev.php（线上环境则应在 produce.php）中

``"LIMS", 'MAIN_SERVER' => [ 'LISTEN_ADDRESS' => '0.0.0.0', 'PORT' => 9501, // 此处修改监听端口号 ... ], 'TEMP_DIR' => null, 'LOG_DIR' => null];``

然后重新启动服务，即可成功启动服务。

**2**、**Socket 监听失败**

判断是否为端口占用所导致的监听失败，这里还是采用 lsof 命令来查看端口

``lsof -i:9501``

1024 以下端口需要 root 权限监听，所以这里要特别注意

**3、外网无法访问**

注意：当服务成功启动后，如果外网无法访问，可以使用 telnet 客户端查看对应的端口是否开放成功，前提是首先环境得有 telnet 客户端 (具体如何安装 telnet 客户端请用户自行百度谷歌查询)，检查端口开放命令如下：telnet 公网 ip/内网 ip 端口号，例如：telnet 192.168.0.1 9501。端口开放成功，则会立刻跳转，不成功，则会有对应的提示。用户可根据对应的提示进行判断。

检查服务监听端口是否为 0.0.0.0

检查防火墙是否对外开放

`` netstat -anp``

// 如果相关端口被防火墙拦截，需要放开

``firewall-cmd --zone=public --add-port=9501/tcp --permanent``

如果为阿里云、腾讯云等云服务器，请检查服务器安全组是否放行对应端口。同样可以使用上述注意事项的 telnet 客户端自行检查。

以上 shell 命令适用于 centos 7，其它 linux 发行版请自行查找相关命令。

**4、请求数据时 DNS 报错**

原因：有时会发现在使用 Swoole 的 MySQL、HttpClient、Redis 等客户端发送请求时，出现了 DNS 错误，类似于 DNS Lookup resolve failed... 错误，这是由于 Swoole 底层对一些 DNS 不是很友好。

解决方法：建议使用阿里云公共 DNS，具体如何配置阿里云公共 DNS，请看 https://www.alidns.com/knowledge?type=SETTING_DOCS#user_linux

**附：系统故障排查流程图**

![image.png](https://foruda.gitee.com/images/1668480820983855802/30e81537_68661.png)

